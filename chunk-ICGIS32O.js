import{a as P,b as m}from"./chunk-RILC2ZGZ.js";import{a as l,b}from"./chunk-AHT2WOHS.js";import{Da as g,L as c,O as v,U as S,a as p,b as h,j as f,n as o,q as i,y as d}from"./chunk-WPZFAPEJ.js";var E=class u{http=S(b);adapter=S(P);apiUrl=m.apiUrl;pedidosState=new f([]);statsState=new f({totalPendientes:0,enHorno:0,producidosHoy:0,entregadosHoy:0});pedidosSignal=g([]);statsSignal=g({totalPendientes:0,enHorno:0,producidosHoy:0,entregadosHoy:0});pedidosLoaded=!1;statsLoaded=!1;constructor(){this.pedidosState.subscribe(t=>this.pedidosSignal.set(t)),this.statsState.subscribe(t=>this.statsSignal.set(t))}getDashboardStats(){let t=this.refreshStats();return this.statsLoaded?this.statsState.asObservable():t}refreshStats(){return this.http.get(this.apiUrl).pipe(i(t=>{if(t.status==="error")throw new Error(t.message);let e=this.adapter.adaptStats(t);return this.statsState.next(e),this.statsLoaded=!0,e}),d(t=>(console.error("Error fetching production stats:",t),o(()=>new Error("No se pudo cargar la informaci\xF3n de producci\xF3n.")))))}getPedidos(){let t=this.refreshPedidos();return this.pedidosLoaded?this.pedidosState.asObservable():t}refreshPedidos(){return this.http.get(this.apiUrl).pipe(i(t=>{if(t.status==="error")throw new Error(t.message);let e=this.adapter.adaptPedidos(t);return this.pedidosState.next(e),this.pedidosLoaded=!0,e}),d(t=>(console.error("Error fetching pedidos:",t),o(()=>new Error("No se pudieron cargar los pedidos.")))))}addPedido(t){let e=t.id||crypto.randomUUID(),s=t.fechaEntrega||new Date;typeof s=="string"&&(s=new Date(s));let r={id:e,producto:t.producto||"",talla:t.talla||"",relleno:t.relleno||"",cantidad:t.cantidad||0,fechaEntrega:s,vendedor:t.vendedor||"",estado:t.estado||"Pendiente",nombreCliente:t.nombreCliente||"",notasPastelero:t.notasPastelero||"",notasTienda:t.notasTienda||""},a=this.pedidosState.value;this.pedidosState.next([r,...a]);let w=h(p({},this.adapter.prepareForPost(r)),{action:"add"});return this.http.post(this.apiUrl,JSON.stringify(w),{headers:new l({"Content-Type":"text/plain;charset=utf-8"})}).pipe(i(n=>{if(n.status==="error")throw new Error(n.message||"Error en el servidor");return n}),c(()=>{this.statsLoaded=!1}),d(n=>(this.pedidosState.next(a),o(()=>new Error(n.message||"Error al guardar. Se ha revertido el cambio.")))))}updatePedido(t){typeof t.fechaEntrega=="string"&&(t.fechaEntrega=new Date(t.fechaEntrega));let e=this.pedidosState.value;this.pedidosState.next(e.map(r=>r.id===t.id?p({},t):r));let s=h(p({},this.adapter.prepareForPost(t)),{action:"updateOrder"});return this.http.post(this.apiUrl,JSON.stringify(s),{headers:new l({"Content-Type":"text/plain;charset=utf-8"})}).pipe(i(r=>{if(r.status==="error")throw new Error(r.message||"Error en el servidor");return r}),c(()=>{this.statsLoaded=!1}),d(r=>(this.pedidosState.next(e),o(()=>new Error(r.message||"Error al actualizar. Se ha revertido el cambio.")))))}updatePedidoStatus(t,e){let s=this.pedidosState.value;this.pedidosState.next(s.map(a=>a.id===t?h(p({},a),{estado:e}):a));let r={action:"updateStatus",id:t,estado:e};return this.http.post(this.apiUrl,JSON.stringify(r),{headers:new l({"Content-Type":"text/plain;charset=utf-8"})}).pipe(i(a=>{if(a.status==="error")throw new Error(a.message||"Error en el servidor");return a}),c(()=>{this.statsLoaded=!1}),d(a=>(this.pedidosState.next(s),o(()=>new Error(a.message||"Error al actualizar. Se ha revertido el cambio.")))))}static \u0275fac=function(e){return new(e||u)};static \u0275prov=v({token:u,factory:u.\u0275fac,providedIn:"root"})};export{E as a};
