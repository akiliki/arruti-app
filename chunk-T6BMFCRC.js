import{a as g,b as v}from"./chunk-ORCUSZZD.js";import{I as S,a as c,b as h,d as l,g as o,h as i,k as d,n as u,q as P,t as f,ta as b,ua as m}from"./chunk-ALWVHIEC.js";var w=class p{http=f(m);adapter=f(g);apiUrl=v.apiUrl;pedidosState=new l([]);statsState=new l({totalPendientes:0,enHorno:0,producidosHoy:0,entregadosHoy:0});pedidosSignal=S([]);statsSignal=S({totalPendientes:0,enHorno:0,producidosHoy:0,entregadosHoy:0});pedidosLoaded=!1;statsLoaded=!1;constructor(){this.pedidosState.subscribe(t=>this.pedidosSignal.set(t)),this.statsState.subscribe(t=>this.statsSignal.set(t))}getDashboardStats(){let t=this.refreshStats();return this.statsLoaded?this.statsState.asObservable():t}refreshStats(){return this.http.get(this.apiUrl).pipe(i(t=>{if(t.status==="error")throw new Error(t.message);let e=this.adapter.adaptStats(t);return this.statsState.next(e),this.statsLoaded=!0,e}),d(t=>(console.error("Error fetching production stats:",t),o(()=>new Error("No se pudo cargar la informaci\xF3n de producci\xF3n.")))))}getPedidos(){let t=this.refreshPedidos();return this.pedidosLoaded?this.pedidosState.asObservable():t}refreshPedidos(){return this.http.get(this.apiUrl).pipe(i(t=>{if(t.status==="error")throw new Error(t.message);let e=this.adapter.adaptPedidos(t);return this.pedidosState.next(e),this.pedidosLoaded=!0,e}),d(t=>(console.error("Error fetching pedidos:",t),o(()=>new Error("No se pudieron cargar los pedidos.")))))}addPedido(t){let e=t.id||crypto.randomUUID(),a=t.fechaEntrega||new Date;typeof a=="string"&&(a=new Date(a));let n={id:e,producto:t.producto||"",cantidad:t.cantidad||0,fechaEntrega:a,estado:t.estado||"Pendiente",nombreCliente:t.nombreCliente||"",notasPastelero:t.notasPastelero||"",notasTienda:t.notasTienda||""},r=this.pedidosState.value;this.pedidosState.next([n,...r]);let y=h(c({},this.adapter.prepareForPost(n)),{action:"add"});return this.http.post(this.apiUrl,JSON.stringify(y),{headers:new b({"Content-Type":"text/plain;charset=utf-8"})}).pipe(i(s=>{if(s.status==="error")throw new Error(s.message||"Error en el servidor");return s}),u(()=>{this.statsLoaded=!1}),d(s=>(this.pedidosState.next(r),o(()=>new Error(s.message||"Error al guardar. Se ha revertido el cambio.")))))}updatePedidoStatus(t,e){let a=this.pedidosState.value;this.pedidosState.next(a.map(r=>r.id===t?h(c({},r),{estado:e}):r));let n={action:"updateStatus",id:t,estado:e};return this.http.post(this.apiUrl,JSON.stringify(n),{headers:new b({"Content-Type":"text/plain;charset=utf-8"})}).pipe(i(r=>{if(r.status==="error")throw new Error(r.message||"Error en el servidor");return r}),u(()=>{this.statsLoaded=!1}),d(r=>(this.pedidosState.next(a),o(()=>new Error(r.message||"Error al actualizar. Se ha revertido el cambio.")))))}static \u0275fac=function(e){return new(e||p)};static \u0275prov=P({token:p,factory:p.\u0275fac,providedIn:"root"})};export{w as a};
