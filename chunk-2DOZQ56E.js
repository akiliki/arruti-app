import{a as b,b as E}from"./chunk-BKTZ77TT.js";import{a as h,b as v}from"./chunk-MLTMCV35.js";import{Ea as S,M as c,P as m,V as P,a as l,b as u,j as g,n as d,q as n,y as p}from"./chunk-ISGLS2OQ.js";var w=class f{http=P(v);adapter=P(b);apiUrl=E.apiUrl;pedidosState=new g([]);statsState=new g({totalPendientes:0,enHorno:0,producidosHoy:0,entregadosHoy:0});pedidosSignal=S([]);statsSignal=S({totalPendientes:0,enHorno:0,producidosHoy:0,entregadosHoy:0});pedidosLoaded=!1;statsLoaded=!1;constructor(){this.pedidosState.subscribe(t=>this.pedidosSignal.set(t)),this.statsState.subscribe(t=>this.statsSignal.set(t))}getDashboardStats(){let t=this.refreshStats();return this.statsLoaded?this.statsState.asObservable():t}refreshStats(){return this.http.get(this.apiUrl).pipe(n(t=>{if(t.status==="error")throw new Error(t.message);let r=this.adapter.adaptStats(t);return this.statsState.next(r),this.statsLoaded=!0,r}),p(t=>(console.error("Error fetching production stats:",t),d(()=>new Error("No se pudo cargar la informaci\xF3n de producci\xF3n.")))))}getPedidos(){return this.pedidosLoaded?this.pedidosState.asObservable():this.refreshPedidos()}refreshPedidos(){return this.http.get(this.apiUrl).pipe(n(t=>{if(t.status==="error")throw new Error(t.message);let r=this.adapter.adaptPedidos(t);return this.pedidosState.next(r),this.pedidosLoaded=!0,r}),p(t=>(console.error("Error fetching pedidos:",t),d(()=>new Error("No se pudieron cargar los pedidos.")))),c({complete:()=>this.pedidosLoaded=!0}))}addPedido(t){let r=t.id||crypto.randomUUID(),o=t.fechaEntrega||new Date;typeof o=="string"&&(o=new Date(o));let a={id:r,idGrupo:t.idGrupo||"",producto:t.producto||"",talla:t.talla||"",relleno:t.relleno||"",cantidad:t.cantidad||0,fechaEntrega:o,vendedor:t.vendedor||"",estado:t.estado||"Pendiente",nombreCliente:t.nombreCliente||"",notasPastelero:t.notasPastelero||"",notasTienda:t.notasTienda||"",guardadoEnTienda:t.guardadoEnTienda||!1},s=this.pedidosState.value;this.pedidosState.next([a,...s]);let e=u(l({},this.adapter.prepareForPost(a)),{action:"add"});return this.http.post(this.apiUrl,JSON.stringify(e),{headers:new h({"Content-Type":"text/plain;charset=utf-8"})}).pipe(n(i=>{if(i.status==="error")throw new Error(i.message||"Error en el servidor");return i}),c(()=>{this.statsLoaded=!1}),p(i=>(this.pedidosState.next(s),d(()=>new Error(i.message||"Error al guardar. Se ha revertido el cambio.")))))}addPedidos(t){let r=new Date,o=t.map(e=>({id:e.id||crypto.randomUUID(),idGrupo:e.idGrupo||"",producto:e.producto||"",talla:e.talla||"",relleno:e.relleno||"",cantidad:e.cantidad||1,fechaEntrega:e.fechaEntrega instanceof Date?e.fechaEntrega:new Date(e.fechaEntrega||r),estado:e.estado||"Pendiente",nombreCliente:e.nombreCliente||"",notasPastelero:e.notasPastelero||"",notasTienda:e.notasTienda||"",vendedor:e.vendedor||"",guardadoEnTienda:e.guardadoEnTienda||!1,fechaActualizacion:r})),a=this.pedidosState.value;this.pedidosState.next([...o,...a]);let s={action:"addPedidos",pedidos:o.map(e=>this.adapter.prepareForPost(e))};return this.http.post(this.apiUrl,JSON.stringify(s),{headers:new h({"Content-Type":"text/plain;charset=utf-8"})}).pipe(n(e=>{if(e.status==="error")throw new Error(e.message||"Error en el servidor");return e}),c(()=>{this.statsLoaded=!1}),p(e=>(this.pedidosState.next(a),d(()=>new Error(e.message||"Error al guardar. Se ha revertido el cambio.")))))}updatePedido(t){typeof t.fechaEntrega=="string"&&(t.fechaEntrega=new Date(t.fechaEntrega));let r=this.pedidosState.value;this.pedidosState.next(r.map(a=>a.id===t.id?l({},t):a));let o=u(l({},this.adapter.prepareForPost(t)),{action:"updateOrder"});return this.http.post(this.apiUrl,JSON.stringify(o),{headers:new h({"Content-Type":"text/plain;charset=utf-8"})}).pipe(n(a=>{if(a.status==="error")throw new Error(a.message||"Error en el servidor");return a}),c(()=>{this.statsLoaded=!1}),p(a=>(this.pedidosState.next(r),d(()=>new Error(a.message||"Error al actualizar. Se ha revertido el cambio.")))))}updatePedidos(t){let r=new Date,o=this.pedidosState.value,a=o.map(e=>{let i=t.find(y=>y.id===e.id);return i?u(l(l({},e),i),{fechaActualizacion:r}):e});this.pedidosState.next(a);let s={action:"updateMultipleOrders",pedidos:t.map(e=>this.adapter.prepareForPost(e))};return this.http.post(this.apiUrl,JSON.stringify(s),{headers:new h({"Content-Type":"text/plain;charset=utf-8"})}).pipe(n(e=>{if(e.status==="error")throw new Error(e.message||"Error al actualizar");return e}),c(()=>{this.statsLoaded=!1}),p(e=>(this.pedidosState.next(o),d(()=>new Error(e.message)))))}updatePedidoStatus(t,r){let o=this.pedidosState.value;this.pedidosState.next(o.map(s=>s.id===t?u(l({},s),{estado:r}):s));let a={action:"updateStatus",id:t,estado:r};return this.http.post(this.apiUrl,JSON.stringify(a),{headers:new h({"Content-Type":"text/plain;charset=utf-8"})}).pipe(n(s=>{if(s.status==="error")throw new Error(s.message||"Error en el servidor");return s}),c(()=>{this.statsLoaded=!1}),p(s=>(this.pedidosState.next(o),d(()=>new Error(s.message||"Error al actualizar. Se ha revertido el cambio.")))))}static \u0275fac=function(r){return new(r||f)};static \u0275prov=m({token:f,factory:f.\u0275fac,providedIn:"root"})};export{w as a};
